<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>회원가입</title>
    <script>
        function sendVerificationCode() {
            const email = document.getElementById("email").value;
            if (!email) {
                alert("이메일을 입력해주세요.");
                return;
            }

            fetch(`/auth/send-email?email=${email}`, {
                method: "POST"
            })
            .then(response => {
                if (response.ok) {
                    alert("인증번호가 이메일로 전송되었습니다.");
                } else {
                    alert("이메일 전송 실패!");
                }
            })
            .catch(error => alert("오류 발생: " + error.message));
        }

        function verifyEmail() {
            const email = document.getElementById("email").value;
            const code = document.getElementById("verificationCode").value;

            fetch(`/auth/verify-email?email=${email}&code=${code}`, {
                method: "POST"
            })
            .then(response => response.text())
            .then(data => {
                if (data === "이메일 인증 성공") {
                    alert("이메일 인증이 완료되었습니다.");
                    document.getElementById("emailVerified").value = "true"; // 이메일 인증 완료 표시
                } else {
                    alert("인증번호가 올바르지 않습니다.");
                }
            })
            .catch(error => alert("오류 발생: " + error.message));
        }

        function submitSignup(event) {
            event.preventDefault();

            if (document.getElementById("emailVerified").value !== "true") {
                alert("이메일 인증을 완료해주세요.");
                return;
            }

            const formData = {
                userid: document.getElementById("userid").value,
                name: document.getElementById("name").value,
                password: document.getElementById("password").value,
                password2: document.getElementById("password2").value,
                phone: document.getElementById("phone").value,
                email: document.getElementById("email").value
            };

            fetch("/auth/signup", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.text())
            .then(data => {
                alert("회원가입 성공! 홈페이지로 이동합니다.");
                window.location.href = "/";
            })
            .catch(error => {
                alert("회원가입 실패: " + error.message);
            });
        }
    </script>
</head>
<body>
    <div th:replace="~{navbar}"></div>  <!-- ✅ 네비게이션 바 포함 -->

    <h1>회원가입</h1>
    <form onsubmit="submitSignup(event)">
        <label>아이디:</label>
        <input type="text" id="userid" required/><br>

        <label>이름:</label>
        <input type="text" id="name" required/><br>

        <label>비밀번호:</label>
        <input type="password" id="password" required/><br>

        <label>비밀번호 확인:</label>
        <input type="password" id="password2" required/><br>

        <label>전화번호:</label>
        <input type="text" id="phone" required/><br>

        <label>이메일:</label>
        <input type="email" id="email" required/>
        <button type="button" onclick="sendVerificationCode()">인증번호 요청</button><br>

        <label>인증번호 입력:</label>
        <input type="text" id="verificationCode" required/>
        <button type="button" onclick="verifyEmail()">인증번호 확인</button><br>

        <input type="hidden" id="emailVerified" value="false"/> <!-- 이메일 인증 여부 저장 -->

        <button type="submit">회원가입</button>
    </form>
    <a href="/"><button>홈으로 가기</button></a>
</body>
</html>
